<!DOCTYPE html>
<html>
    <head>
        <title>Reeder</title>
        <script>
            let index = 0;
            let chunk = 0;
            let text = "";
            let mapped_text = [];
            let displayed_text = "";
            let speed = 0;
            let wpm = 0;
            let timeout = 0;
            let display;
            let trail = false;
            let running = false;
            function load_text() {
                text = document.getElementById("content").value;
                // Map text
                mapped_text = text.split(/[\s\n]+/);
                read_handler();
                read_reset();
                console.log("Loaded text");
            }
            function get_chunk() {
                chunk = parseInt(document.getElementById("chunk").value);
                console.log("Chunk has been set");
            }
            function get_speed(_value) {
                let value = _value ?? document.getElementById("wpm").value;
                wpm = parseInt(value);
                speed = 1000 / (wpm / 60);
                console.log("Speed has been set");
            }
            function set_display() {
                display = document.getElementById("display");
            }
            function get_trail() {
                trail = document.getElementById("trail").checked;
            }
            function read_start() {
                if(!running) {
                    timeout = setInterval(read_handler, speed);
                    running = true;
                }
                hide_elements();
                read_handler();
                console.log("Reading has begun");
            }
            function read_pause() {
                clearTimeout(timeout);
                timeout = null;
                running = false;
                show_elements();
            }
            function read_reset() {
                index = 0;
                read_pause();
            }
            function read_seek(value) {
                index += value;
                if(index >= mapped_text.length) index = mapped_text.length - 1
                if(index < 0) index = 0;
                read_handler();
            }
            function change_speed(value) {
                console.log(wpm+value);
                if(wpm + value < 0) return;
                get_speed(wpm + value);
                read_pause();
                read_start();
            }
            function increment_head() {
                let buffer = "";
                if(trail && index > 0) buffer += mapped_text[index - 1] + " ";
                for(let i = 0; i < chunk; i++) {
                    if(index >= mapped_text.length) break;
                    buffer += mapped_text[index] + " ";
                    index++;
                }
                displayed_text = buffer;
            }
            function hide_elements() {
                let elements = document.getElementsByClassName("controls");
                for(let element of elements) {
                    if(element.type !== "hidden") element.oldtype = element.type;
                    element.type = "hidden";
                    element.hidden = true;
                }
            }
            function show_elements() {
                let elements = document.getElementsByClassName("controls");
                for(let element of elements) {
                    element.type = element.oldtype ?? element.type;
                    element.hidden = false;
                }
            }
            function read_handler() {
                increment_head();
                display.setHTML(displayed_text);
                if(index >= mapped_text.length) {
                    read_reset();
                    console.log("Reading finished")
                    return;
                }
            }

            // Startup
            setTimeout(() => {
                set_display();
                get_chunk();
                get_speed();
                load_text();
                read_pause();
                display.hidden = false;
            }, 30);
        </script>
    </head>
    <style>
        head {
            background-color: white;
        }
        body {
            background-color: white;
            margin: 0 auto;
            width: 100%;
            padding: 10px;
            align-self: center;
            align-content: center;
            align-items: center;
            font-family: sans-serif;
            vertical-align: middle;
            margin-left: auto;
            margin-top: 10px;
        }
        input {font-size: medium;
            width:min-content;
            height:fit-content;
            border-radius:10px;
            display:inline-block;
            text-align:center; 
            position:relative;
        }
        t {color: black; margin: auto}
    </style>
    <body>
        <br>
        <input type="button" class="controls" value="Play" onclick="read_start()">
        <br>
        <input type="button" value="Pause" onclick="read_pause()">
        <br>
        <input type="button" value="Seek Back" onclick="read_seek(-20)">
        <input type="button" value="Seek Forward" onclick="read_seek(12)">
        <br>
        <input type="button" value="Slow" onclick="change_speed(-130)">
        <input type="button" value="Speed" onclick="change_speed(130)">
        <br>
        <input type="button" class="controls" value="Reset" onclick="read_reset()">

        <br> <br>

        <t class="controls">
            Words Per Minute:
        </t>
        <input type="text" id="wpm" class="controls" value="500" oninput="get_speed()">
        <br>

        <t class="controls">
            Chunk Size:
        </t>
        <input type="text" id="chunk" class="controls" value="1" oninput="get_chunk()">

        <br> <br>
        <input type="text" id="content" class="controls" value="The Quick Brown Fox Jumps Over The Lazy Dog" onchange="load_text()">
        <br>
        <t class="controls">
            Trail words:
        </t>
        <input type="checkbox" id="trail" class="controls" onchange="get_trail()">
        <br>
        <center id="display" style="font-size: 140px;color:black; text-align: center">
            Reeder
        </center>
    </body>
</html>